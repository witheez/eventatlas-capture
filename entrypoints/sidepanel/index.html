<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EventAtlas Capture</title>
  <link rel="stylesheet" href="sidepanel.css">
</head>
<body>
  <div class="header">
    <h1 id="headerTitle">EventAtlas Capture</h1>
    <div class="header-buttons">
      <span class="header-badge" id="captureBadge">No captures</span>
      <span id="eventListSyncTime" class="event-list-sync-time"></span>
      <button class="header-btn" id="refreshBtn" title="Refresh page data">&#8635;</button>
      <button class="header-btn" id="settingsBtn" title="Settings">&#9881;</button>
    </div>
  </div>

  <!-- Settings Panel -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-title">Settings</div>
    <div class="setting-row">
      <div>
        <div class="setting-label">Auto-group by domain</div>
        <div class="setting-desc">Captures from the same domain go to the same bundle</div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="autoGroupSetting" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>
    <div class="setting-row">
      <div>
        <div class="setting-label">Capture screenshots by default</div>
        <div class="setting-desc">Include screenshot with every capture (slower)</div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="screenshotDefaultSetting">
        <span class="toggle-slider"></span>
      </label>
    </div>

    <!-- EventAtlas API Settings -->
    <div class="settings-divider"></div>
    <div class="settings-title" style="margin-top: 16px;">EventAtlas API</div>

    <div class="setting-row setting-row-vertical">
      <div class="setting-label">API URL</div>
      <input type="text" class="setting-input" id="apiUrlSetting" placeholder="https://your-app.up.railway.app">
    </div>

    <div class="setting-row setting-row-vertical">
      <div class="setting-label">API Token</div>
      <div class="input-with-toggle">
        <input type="password" class="setting-input" id="apiTokenSetting" placeholder="Enter your API token">
        <button type="button" class="toggle-visibility-btn" id="toggleTokenVisibility" title="Show/hide token">
          <span class="eye-icon">üëÅ</span>
        </button>
      </div>
    </div>

    <div class="setting-row setting-row-vertical">
      <div class="setting-label">Sync Mode</div>
      <select class="setting-select" id="syncModeSetting">
        <option value="bulk_only">Bulk only</option>
        <option value="realtime_only">Real-time only</option>
        <option value="both">Both (recommended)</option>
      </select>
    </div>

    <div class="setting-row setting-row-vertical">
      <div class="setting-label">Distance Presets</div>
      <div class="setting-desc">Click to enable/disable. Disabled distances won't appear in the editor.</div>
      <div class="distance-preset-toggles" id="distancePresetToggles">
        <button type="button" class="distance-preset-chip enabled" data-value="5">5K</button>
        <button type="button" class="distance-preset-chip enabled" data-value="10">10K</button>
        <button type="button" class="distance-preset-chip enabled" data-value="21">HM</button>
        <button type="button" class="distance-preset-chip enabled" data-value="42">FM</button>
        <button type="button" class="distance-preset-chip enabled" data-value="50">50K</button>
        <button type="button" class="distance-preset-chip enabled" data-value="100">100K</button>
        <button type="button" class="distance-preset-chip enabled" data-value="161">100M</button>
      </div>
      <div class="setting-desc" style="margin-top: 8px;">Add custom distances (comma-separated km values)</div>
      <input type="text" class="setting-input" id="customDistancePresets" placeholder="e.g., 25, 35, 80">
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Screenshot upload timing</div>
        <div class="setting-desc">When to upload captured screenshots</div>
      </div>
      <select class="setting-select" id="screenshotUploadTiming" style="width: auto; min-width: 120px;">
        <option value="immediate">Immediately</option>
        <option value="on_save">On Save</option>
      </select>
    </div>

    <div class="settings-divider"></div>
    <div class="settings-title" style="margin-top: 16px;">Event List</div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Auto-switch to Current tab</div>
        <div class="setting-desc">Switch to edit view when clicking an event</div>
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="autoSwitchTabSetting" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>

    <div class="setting-row">
      <div>
        <div class="setting-label">Background refresh</div>
        <div class="setting-desc">Periodically refresh event list</div>
      </div>
      <select class="setting-select" id="eventListRefreshInterval" style="width: auto; min-width: 120px;">
        <option value="0">Off</option>
        <option value="5">Every 5 minutes</option>
        <option value="10">Every 10 minutes</option>
        <option value="30">Every 30 minutes</option>
      </select>
    </div>

    <div class="setting-row" style="gap: 8px;">
      <button class="save-settings-btn" id="saveSettingsBtn">Save Settings</button>
      <button class="test-connection-btn" id="testConnectionBtn">Test Connection</button>
    </div>
    <div class="setting-row">
      <span class="connection-status" id="connectionStatus"></span>
    </div>
  </div>

  <!-- Tab navigation -->
  <div class="tab-navigation" id="tabNavigation">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="current">Current</button>
      <button class="tab-btn" data-tab="event-list">Event List</button>
    </div>
    <div class="tab-nav-arrows" id="tabNavArrows">
      <span class="tab-nav-progress" id="tabNavProgress">1/10</span>
      <button class="tab-nav-arrow" id="prevEventBtn" title="Previous event">‚Äπ</button>
      <button class="tab-nav-arrow" id="nextEventBtn" title="Next event">‚Ä∫</button>
    </div>
  </div>

  <!-- Back navigation -->
  <div class="back-nav" id="backNav">
    <span class="back-nav-arrow">&#8592;</span>
    <span class="back-nav-text" id="backNavText">Back to Bundles</span>
  </div>

  <!-- Event List View -->
  <div class="view" id="eventListView" style="display: none;">
    <!-- Filters -->
    <div class="event-list-filters">
      <label class="filter-checkbox"><input type="checkbox" id="filterMissingTags"> Missing tags</label>
      <label class="filter-checkbox"><input type="checkbox" id="filterMissingDistances"> Missing distances</label>
      <div class="filter-starts-from">
        <select id="filterStartsFrom" class="filter-select" title="Filter by start date">
          <!-- Options populated by JS -->
        </select>
        <div id="customDateContainer" class="custom-date-container" style="display: none;">
          <input type="date" id="filterCustomDate" class="filter-date-input" title="Select minimum start date">
        </div>
      </div>
      <div class="filter-mode-toggle">
        <button class="filter-mode-btn active" data-mode="any">Any</button>
        <button class="filter-mode-btn" data-mode="all">All</button>
      </div>
    </div>

    <!-- Event list -->
    <div class="event-list" id="eventListContainer">
      <!-- Items rendered by JS -->
    </div>

    <!-- Loading state -->
    <div class="event-list-loading" id="eventListLoading" style="display: none;">
      Loading events...
    </div>

    <!-- Empty state -->
    <div class="event-list-empty" id="eventListEmpty" style="display: none;">
      No events match your filters
    </div>
  </div>

  <!-- Main View (Bundles with Accordion) -->
  <div class="view active" id="bundlesView">
    <!-- Combined page info section -->
    <div class="page-info-section" id="pageInfoSection">
      <div class="page-info-header">
        <div class="page-info-title-row">
          <div class="page-info-title" id="pageTitle">Loading...</div>
          <div class="page-info-url" id="pageUrl"></div>
        </div>
      </div>
    </div>

    <!-- Status section (right-aligned badge + View link) -->
    <div class="status-section" id="statusSection" style="display: none;">
      <div class="status-section-inner">
        <span class="page-info-badge loading" id="pageInfoBadge">
          <span id="pageInfoBadgeIcon">&#8943;</span>
          <span id="pageInfoBadgeText">Checking...</span>
        </span>
        <a class="status-view-link" id="statusViewLink" href="#" target="_blank" style="display: none;">View &#8594;</a>
      </div>
    </div>

    <!-- Legacy page info details (hidden, kept for JS compatibility) -->
    <div class="page-info-details" id="pageInfoDetails" style="display: none;">
      <div class="page-info-details-row">
        <span class="page-info-event-name" id="pageInfoEventName"></span>
        <a class="admin-link" id="pageInfoAdminLink" href="#" target="_blank" style="display: none;">View &#8594;</a>
      </div>
    </div>

    <!-- Legacy URL Status Indicator (hidden, kept for JS compatibility) -->
    <div id="urlStatusContainer" class="url-status-container" style="display: none;">
      <div id="urlStatusBadge" class="url-status-badge"></div>
      <div id="urlStatusDetails" class="url-status-details"></div>
    </div>

    <!-- Quick Add to Pipeline Section -->
    <div id="quickAddSection" class="quick-add-section" style="display: none;">
      <h4>Add to Pipeline</h4>

      <!-- Loading State -->
      <div id="quickAddLoading" class="quick-add-loading" style="display: none;">
        <div class="loading-spinner-small"></div>
        <span>Checking for parent...</span>
      </div>

      <!-- Parent Found (Website Scraper) -->
      <div id="quickAddParentFound" style="display: none;">
        <div class="info-box success">
          <span class="info-icon">&#10003;</span>
          <div class="info-content">
            <strong>Found parent: <span id="parentDisplayName"></span></strong>
            <p>Will use: <span id="inheritedProcessorName"></span></p>
          </div>
        </div>
        <div class="quick-add-options">
          <label class="toggle-option">
            <input type="checkbox" id="parentAutoProcess" />
            <span class="toggle-label">Auto-process after import</span>
          </label>
          <label class="toggle-option">
            <input type="checkbox" id="parentCleanUrls" checked />
            <span class="toggle-label">Clean tracking params</span>
          </label>
        </div>
        <button id="addAsChildBtn" class="add-btn">Add to Pipeline</button>
      </div>

      <!-- Parent Found (API - Blocked) -->
      <div id="quickAddApiBlocked" style="display: none;">
        <div class="info-box warning">
          <span class="info-icon">&#9888;</span>
          <div class="info-content">
            <strong>Parent "<span id="blockedParentName"></span>" uses API scraping</strong>
            <p>Run the parent scraper to discover events automatically.</p>
          </div>
        </div>
        <a id="viewParentLink" href="#" target="_blank" class="view-link">View Parent in Admin &#8594;</a>
      </div>

      <!-- No Parent Found (Standalone) -->
      <div id="quickAddStandalone" style="display: none;">
        <div class="info-box neutral">
          <span class="info-icon">&#8505;</span>
          <div class="info-content">
            <p>No parent found. Select a processor for standalone import:</p>
          </div>
        </div>
        <select id="processorConfigSelect" class="form-select">
          <option value="">Select processor...</option>
        </select>
        <div class="quick-add-options">
          <label class="toggle-option">
            <input type="checkbox" id="standaloneAutoProcess" />
            <span class="toggle-label">Auto-process after import</span>
          </label>
          <label class="toggle-option">
            <input type="checkbox" id="standaloneCleanUrls" checked />
            <span class="toggle-label">Clean tracking params</span>
          </label>
        </div>
        <button id="addStandaloneBtn" class="add-btn" disabled>Add to Pipeline</button>
      </div>
    </div>

    <!-- Event Editor Accordion (shown when URL matches a known event) -->
    <div id="eventEditor" class="event-editor">
      <!-- Accordion Header - contains page title, URL, badge, and view link -->
      <div class="event-editor-accordion-header" id="eventEditorAccordionHeader">
        <!-- Top row: chevron + page title | badge -->
        <div class="event-editor-header-top">
          <div class="event-editor-header-left">
            <span class="event-editor-chevron" id="eventEditorChevron">&#9660;</span>
            <div class="event-editor-header-info">
              <div class="event-editor-page-title" id="editorPageTitle">Page Title</div>
            </div>
          </div>
          <div class="event-editor-header-right">
            <span class="event-editor-badge" id="editorBadge">&#10003; Known Event</span>
          </div>
        </div>
        <!-- Bottom row: URL | View link -->
        <div class="event-editor-header-bottom">
          <div class="event-editor-page-url" id="editorPageUrl">https://example.com</div>
          <a class="event-editor-view-link" id="editorViewLink" href="#" target="_blank">View &#8594;</a>
        </div>
      </div>
      <!-- Hidden: legacy event name element for compatibility -->
      <div id="editorEventName" style="display: none;"></div>


      <!-- Accordion Content -->
      <div class="event-editor-content" id="eventEditorContent">
        <!-- Loading skeleton -->
        <div id="editorLoading" class="editor-loading" style="display: none;">
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-input"></div>
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton-tags">
            <div class="skeleton skeleton-tag"></div>
            <div class="skeleton skeleton-tag"></div>
            <div class="skeleton skeleton-tag"></div>
          </div>
        </div>

        <!-- Editor content -->
        <div id="editorContent">
          <!-- Event Type -->
          <div class="editor-section">
            <label class="editor-label">Event Type <span style="color: #ef4444;">*</span></label>
            <div class="event-types-container" id="editorEventTypes"></div>
            <div id="eventTypeError" class="error-message-inline">Event type is required</div>
          </div>

          <!-- Tags -->
          <div class="editor-section">
            <label class="editor-label">Tags</label>
            <div class="tags-container" id="editorTags"></div>
          </div>

          <!-- Distances -->
          <div class="editor-section">
            <label class="editor-label">Distances</label>
            <div class="distances-container" id="editorDistances"></div>
            <div class="custom-distance-row">
              <input type="number" class="custom-distance-input" id="customDistanceInput" placeholder="km" min="1" max="1000">
              <button class="add-distance-btn" id="addCustomDistanceBtn">Add</button>
            </div>
            <div class="selected-distances" id="selectedDistances"></div>
          </div>

          <!-- Notes -->
          <div class="editor-section">
            <label class="editor-label">Notes</label>
            <textarea class="editor-textarea" id="editorNotes" placeholder="Add notes about this event..."></textarea>
          </div>

          <!-- Action buttons row (Screenshot + Capture HTML) -->
          <div class="editor-section">
            <div class="editor-action-buttons">
              <button class="editor-action-btn screenshot" id="captureEventScreenshotBtn">
                <span>&#128247;</span> Screenshot
              </button>
              <button class="editor-action-btn html-capture" id="captureEventHtmlBtn">
                <span>&#128196;</span> Capture HTML
              </button>
            </div>
          </div>

          <!-- Screenshots grid -->
          <div class="editor-section" id="screenshotsSection">
            <label class="editor-label">Screenshots</label>
            <div id="savedScreenshots" class="saved-screenshots">
              <div class="no-screenshots">No screenshots yet</div>
            </div>
          </div>

          <!-- Save button -->
          <div class="editor-section">
            <button class="editor-save-btn" id="editorSaveBtn">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Capture buttons - adaptive based on screenshot setting -->
    <div class="capture-buttons" id="captureButtons">
      <!-- Single button when screenshot default is ON -->
      <button class="capture-btn" id="captureBtn" style="display: none;">
        <span class="capture-btn-icon">üìÑüì∏</span> Capture Page + Screenshot
      </button>
      <!-- Two buttons when screenshot default is OFF -->
      <div class="capture-btn-group" id="captureBtnGroup">
        <button class="capture-btn capture-btn-main" id="captureNoScreenshotBtn">
          <span class="capture-btn-icon">üìÑ</span> Capture Page
        </button>
        <button class="capture-btn capture-btn-screenshot" id="captureWithScreenshotBtn">
          <span class="capture-btn-icon">üì∏</span> + Screenshot
        </button>
      </div>
    </div>

    <!-- Error message box -->
    <div class="error-message" id="errorMessage">
      <div class="error-message-title" id="errorTitle">Capture failed</div>
      <div class="error-message-hint" id="errorHint"></div>
    </div>

    <!-- Duplicate URL dialog -->
    <div class="duplicate-dialog" id="duplicateDialog">
      <div class="duplicate-dialog-title">Page already in bundle</div>
      <div class="duplicate-dialog-text" id="duplicateText">This URL has already been captured.</div>
      <div class="duplicate-dialog-actions">
        <button class="bundle-action-btn primary" id="duplicateReplace">Replace</button>
        <button class="bundle-action-btn secondary" id="duplicateSkip">Skip</button>
      </div>
    </div>

    <!-- Link Discovery View -->
    <div id="linkDiscoveryView" style="display: none;">
      <div class="discovery-header">
        <div class="discovery-source">
          <span class="discovery-source-name" id="discoverySourceName">Unknown Source</span>
          <span class="discovery-api-badge" id="discoveryApiBadge" style="display: none;">API</span>
        </div>
        <span class="discovery-last-scraped" id="discoveryLastScraped"></span>
      </div>

      <div class="discovery-actions">
        <button id="scanPageLinks" class="scan-btn">
          <span class="scan-btn-icon">&#128269;</span>
          Scan Page for Links
        </button>
      </div>

      <div id="linkComparisonResults" style="display: none;">
        <div class="link-section new-links-section">
          <h4>New Links (<span id="newLinksCount">0</span>)</h4>
          <div class="select-all-row">
            <label><input type="checkbox" id="selectAllNewLinks" checked> Select All</label>
          </div>
          <div id="newLinksList" class="links-list"></div>
          <button id="addNewLinksBtn" class="add-links-btn" style="display: none;">
            Add <span id="selectedLinksCount">0</span> Selected Links to Pipeline
          </button>
        </div>

        <div class="link-section known-links-section">
          <h4>Known Links (<span id="knownLinksCount">0</span>)</h4>
          <div id="knownLinksList" class="links-list"></div>
        </div>
      </div>
    </div>

    <!-- Bundles accordion list -->
    <div class="bundle-section">
      <div class="bundle-section-header">
        <div>
          <div class="bundle-section-title">Bundles</div>
          <div class="bundle-section-count" id="bundlesCount">0 bundles</div>
        </div>
        <button class="bundle-action-btn danger" id="clearAllBundlesBtn">Clear All</button>
      </div>
      <div class="accordion-list" id="bundlesList">
        <div class="bundles-empty">
          <div class="bundles-empty-icon">&#128193;</div>
          <div>No bundles yet. Capture a page to start.</div>
        </div>
      </div>
      <button class="new-bundle-btn-large" id="newBundleBtn">+ New Bundle</button>
    </div>
  </div>

  <!-- Detail View (single page) -->
  <div class="view" id="detailView">
    <div class="preview visible" id="preview">
      <div class="preview-header">
        <span class="preview-title">Captured Content</span>
      </div>

      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-item">
          <div class="stat-value" id="htmlSizeStat">-</div>
          <div class="stat-label">HTML</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="textSizeStat">-</div>
          <div class="stat-label">Text</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="imageSizeStat">-</div>
          <div class="stat-label">Images</div>
        </div>
      </div>

      <!-- Title & URL -->
      <div class="preview-section">
        <div class="preview-section-header">
          <span class="preview-section-title">Page Info</span>
        </div>
        <input type="text" class="editable-field" id="editTitle" placeholder="Page title">
        <input type="text" class="editable-field url-field" id="editUrl" placeholder="URL" style="margin-top: 8px;">
      </div>

      <!-- Screenshot -->
      <div class="preview-section" id="screenshotSection">
        <div class="preview-section-header">
          <span class="preview-section-title">Screenshot</span>
          <span class="preview-section-badge" id="screenshotBadge">-</span>
        </div>
        <div class="screenshot-container" id="screenshotContainer">
          <div class="screenshot-placeholder" id="screenshotPlaceholder">
            <div>No screenshot available</div>
            <button class="add-screenshot-btn" id="addScreenshotBtn">
              <span class="capture-btn-icon">üì∏</span> Add Screenshot
            </button>
          </div>
          <img class="screenshot-thumb" id="screenshotThumb" alt="Page screenshot" style="display: none;">
        </div>
      </div>

      <!-- Text Preview -->
      <div class="preview-section">
        <div class="preview-section-header">
          <span class="preview-section-title">Text Content</span>
          <span class="preview-section-badge" id="textCharCount">0 chars</span>
        </div>
        <div class="text-preview" id="textPreview"></div>
        <button class="text-preview-toggle" id="textToggle">Show more</button>
      </div>

      <!-- Images -->
      <div class="preview-section">
        <div class="preview-section-header">
          <span class="preview-section-title">Images</span>
          <span class="preview-section-badge" id="imageSelectedCount">0 selected</span>
        </div>
        <div class="image-gallery" id="imageGallery"></div>
      </div>

      <!-- Metadata -->
      <div class="preview-section" id="metadataSection">
        <div class="preview-section-header">
          <span class="preview-section-title">Metadata</span>
        </div>
        <div class="metadata-list" id="metadataList"></div>
      </div>

      <!-- Toggles -->
      <div class="preview-section">
        <div class="preview-section-header">
          <span class="preview-section-title">Include in Export</span>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">HTML Content</span>
          <label class="toggle-switch">
            <input type="checkbox" id="includeHtml" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Images</span>
          <label class="toggle-switch">
            <input type="checkbox" id="includeImages" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Screenshot</span>
          <label class="toggle-switch">
            <input type="checkbox" id="includeScreenshot" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <!-- Move to bundle -->
        <div class="move-bundle-section" id="moveBundleSection">
          <div class="move-bundle-label">Move to another bundle</div>
          <select class="move-bundle-select" id="moveBundleSelect">
            <option value="">-- Select bundle --</option>
          </select>
        </div>
      </div>

      <!-- Action buttons -->
      <div class="action-buttons">
        <button class="action-btn primary" id="copyBtn">Copy to Clipboard</button>
        <button class="action-btn secondary" id="removeBtn">Remove from Bundle</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Screenshot Modal -->
  <div class="screenshot-modal" id="screenshotModal">
    <button class="screenshot-modal-close" id="screenshotModalClose">&times;</button>
    <img class="screenshot-modal-content" id="screenshotModalImg" alt="Full screenshot">
  </div>

  <!-- Unsaved Changes Dialog -->
  <div class="unsaved-dialog" id="unsavedDialog">
    <div class="unsaved-dialog-content">
      <div class="unsaved-dialog-title">Unsaved Changes</div>
      <div class="unsaved-dialog-text" id="unsavedDialogText">You have pending screenshots that haven't been uploaded. What would you like to do?</div>
      <div class="unsaved-dialog-actions">
        <button class="unsaved-dialog-btn primary" id="unsavedSaveBtn">Save &amp; Continue</button>
        <button class="unsaved-dialog-btn danger" id="unsavedDiscardBtn">Discard Changes</button>
        <button class="unsaved-dialog-btn secondary" id="unsavedCancelBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Upload Queue (fixed at bottom) -->
  <div class="upload-queue" id="uploadQueue">
    <div class="upload-queue-header">
      <span class="upload-queue-title">Uploading...</span>
      <span class="upload-queue-count" id="uploadQueueCount">0</span>
    </div>
    <div class="upload-queue-items" id="uploadQueueItems">
      <!-- Queue items dynamically added here -->
    </div>
  </div>

  <script type="module" src="main.js"></script>
</body>
</html>
